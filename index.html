<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>4 Exchange MiniApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #152840; color: #f1f1f1; margin: 0; padding: 20px; }
    #main-screen, #form-screen { max-width: 400px; margin: auto; }
    button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; }
    #buyBtn { background-color: #2ecc71; color: white; }
    #sellBtn { background-color: #e74c3c; color: white; }
    #backBtn { background-color: #555; color: white; }
    .rate { font-size: 24px; margin-bottom: 10px; }
    .hidden { display: none; }
    input { width: 100%; padding: 8px; margin: 6px 0; border-radius: 6px; border: none; }
    label { display: block; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="main-screen">
    <h1>4 EXCHANGE</h1>
    <div class="rate" id="buy-rate">–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–∞...</div>
    <div class="rate" id="sell-rate"></div>
    <button id="buyBtn">üü¢ –ö—É–ø–∏—Ç—å USDT</button>
    <button id="sellBtn">üî¥ –ü—Ä–æ–¥–∞—Ç—å USDT</button>
  </div>

  <div id="form-screen" class="hidden">
    <h1 id="form-title"></h1>
    <label>–°—É–º–º–∞ (RUB)</label>
    <input type="number" id="amount" placeholder="1000" />
    <label>–§–ò–û</label>
    <input type="text" id="name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" />
    <label>–ö–æ—à–µ–ª–µ–∫ USDT (TRC20)</label>
    <input type="text" id="wallet" placeholder="Txxxxxxxxxxxxxxxxxxxx" />
    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
    <input type="tel" id="phone" placeholder="+79991234567" />
    <button id="submitBtn">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    <button id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let currentRate = 0;
    let currentOperation = 'buy'; // 'buy' –∏–ª–∏ 'sell'

    async function fetchRate() {
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=rub');
        const data = await res.json();
        currentRate = data.tether.rub;
        document.getElementById('buy-rate').textContent = `üü¢ –ö—É–ø–∏—Ç—å: ${(currentRate + 0.29).toFixed(2)}‚ÇΩ`;
        document.getElementById('sell-rate').textContent = `üî¥ –ü—Ä–æ–¥–∞—Ç—å: ${(currentRate - 0.66).toFixed(2)}‚ÇΩ`;
      } catch {
        document.getElementById('buy-rate').textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–∞";
        document.getElementById('sell-rate').textContent = "";
      }
    }

    function showForm(operation) {
      currentOperation = operation;
      document.getElementById('form-title').textContent = operation === 'buy' ? 'üü¢ –ü–û–ö–£–ü–ö–ê USDT' : 'üî¥ –ü–†–û–î–ê–ñ–ê USDT';
      document.getElementById('main-screen').classList.add('hidden');
      document.getElementById('form-screen').classList.remove('hidden');
    }

    function showMain() {
      document.getElementById('form-screen').classList.add('hidden');
      document.getElementById('main-screen').classList.remove('hidden');
    }

    document.getElementById('buyBtn').addEventListener('click', () => showForm('buy'));
    document.getElementById('sellBtn').addEventListener('click', () => showForm('sell'));
    document.getElementById('backBtn').addEventListener('click', showMain);

    document.getElementById('submitBtn').addEventListener('click', () => {
      const amount = document.getElementById('amount').value.trim();
      const name = document.getElementById('name').value.trim();
      const wallet = document.getElementById('wallet').value.trim();
      const phone = document.getElementById('phone').value.trim();

      if (!amount || !name || !wallet || !phone) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.");
        return;
      }

      const effectiveRate = currentOperation === 'buy' ? currentRate + 0.29 : currentRate - 0.66;

      const data = {
        type: currentOperation,
        rate: effectiveRate,
        amount,
        name,
        wallet,
        phone
      };

      tg.sendData(JSON.stringify(data));
      tg.close();
    });

    fetchRate();
  </script>
</body>
</html>
